{% extends 'base.html' %}
{% load custom_tags %}

{% block content %}
<h4 class="mb-3">Dashboard</h4>
<div id="container" style="width: 50%;">
  <canvas id="sectors-chart"></canvas>
</div>

  <!-- ChartJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@seahsky/chartjs-plugin-autocolors"></script>

  <script>
    // Customize colors with https://www.npmjs.com/package/@seahsky/chartjs-plugin-autocolors#customize
    const autocolors = window['@seahsky/chartjs-plugin-autocolors'];

    let currencySymbol = "{{ currencySymbol }}";
    let valuesDict = [
      [
      {% for stock in stocks.labels %}
        {
          "label" : "{{ stock }}",
          "value" : {{ stocks.values|index:forloop.counter0 }},
        },
      {% endfor %}
      ], [
      {% for sector in sectors.labels %}
        {
          "label" : "{{ sector }}",
          "value" : {{ sectors.values|index:forloop.counter0 }},
        },
      {% endfor %}
      ],
    ];

    const data = {
      labels: {{ sectors.labels|safe }},
      datasets: [
        {
          data: {{ stocks.values }},
          borderWidth: 1,
        },
        {
          data: {{ sectors.values }},
          borderWidth: 2,
        }
      ]
    };

    const config = {
      type: 'doughnut',
      data: data,
      plugins: [
        autocolors
      ],
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                var stockValue = valuesDict[context.datasetIndex][context.dataIndex].value;
                stockValue = Intl.NumberFormat().format(stockValue);
                return valuesDict[context.datasetIndex][context.dataIndex].label + ': ' + currencySymbol + ' ' + stockValue;
              }
            }
          },
          title: {
            display: true,
            text: 'Sector Position Sizes',
            font: {
              size: 20
            }
          },
          autocolors: {
            mode: 'data',
            offset: 5,
          }
        }
      },
    };

    let chart = new Chart(document.getElementById("sectors-chart").getContext("2d"), config);
  </script>
{% endblock %}