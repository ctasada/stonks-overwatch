{% extends 'base.html' %}
{% load custom_tags %}

{% block content %}
<h4 class="mb-3">Dashboard</h4>
<div id="container" style="width: 50%;">
  <canvas id="sectors-chart"></canvas>
</div>

  <!-- ChartJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.2.1"></script>
  
  <!-- Import ChromaJS via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>

  <script>
    const dataLenght = {{ sectors.labels|length }} + {{ stocks.labels|length }};

    var sectorTypes = {{ sectors.labels|safe }};
    var stocksPerSector = {{ stocksPerSector|safe }};
    
    // chromatic color data
    var sectorColors = chroma.scale('Set3').colors(sectorTypes.length);
    var stockColors = [];

    var i = 0;
    for (const [key, value] of Object.entries(stocksPerSector)) {
      chromaColor = chroma(sectorColors[i]);
      for (var j = 0; j < value.length; j++) {
        stockColors.push(chromaColor.darken(j + 1).hex());
      }
      i++;
    }

    let currencySymbol = "{{ currencySymbol }}";
    let valuesDict = [
      [
      {% for sector in sectors.labels %}
        {
          "label" : "{{ sector }}",
          "value" : {{ sectors.values|index:forloop.counter0 }},
        },
      {% endfor %}
      ], [
      {% for stock in stocks.labels %}
        {
          "label" : "{{ stock }}",
          "value" : {{ stocks.values|index:forloop.counter0 }},
        },
      {% endfor %}
      ],
    ];

    const data = {
      labels: {{ sectors.labels|safe }}.concat({{ stocks.labels|safe }}),
      datasets: [
        {
          data: {{ sectors.values }},
          backgroundColor: sectorColors,
          borderWidth: 2,
        },
        {
          data: {{ stocks.values }},
          backgroundColor: stockColors,
          borderWidth: 1,
        }
      ]
    };

    const config = {
      type: 'doughnut',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return valuesDict[context.datasetIndex][context.dataIndex].label + ': ' + currencySymbol + valuesDict[context.datasetIndex][context.dataIndex].value;
              }
            }
          },
          title: {
            display: true,
            text: 'Sector Position Sizes',
            font: {
              size: 20
            }
          }
        }
      },
    };

    let chart = new Chart(document.getElementById("sectors-chart").getContext("2d"), config);
  </script>
{% endblock %}