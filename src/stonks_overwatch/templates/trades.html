{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- Bootstrap Table Sticky Header CSS -->
<link href="{% static 'bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.css' %}" rel="stylesheet">
<style>
    /* Allow sticky header to work - remove overflow from scrollable-area on this page */
    body:has(#trades-table) .scrollable-area,
    body.trades-page .scrollable-area {
        overflow: visible !important;
    }

    /* Ensure Bootstrap Table's own scroll container works */
    #trades-table + .bootstrap-table .fixed-table-container {
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }

    /* Fix sticky header positioning within Bootstrap Table's scroll container */
    .fixed-table-header {
        position: sticky !important;
        top: 0 !important;
        z-index: 1000 !important;
        background-color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid row-gap-5">
    <div class="row border border-primary-subtle bg-light rounded mb-3 position-relative">
        <p class="h4 position-absolute top-0 start-0 z-2 px-3" style="padding-top: 8px; padding-left: 4px">Trades</p>
        <table id="trades-table">
            <thead>
                <tr>
                    <th data-field="date" data-sortable="true" data-width="100" data-width-unit="px">Date</th>
                    <th data-field="buy_sell" data-sortable="true" data-width="100" data-width-unit="px">Action</th>
                    <th data-field="symbol" data-sortable="true">Stock</th>
                    <th data-field="price" data-sortable="true" data-width="120" data-width-unit="px">Price</th>
                    <th data-field="quantity" data-sortable="true" data-width="100" data-width-unit="px">Quantity</th>
                    <th data-field="total" data-sortable="true" data-width="100" data-width-unit="px">Local Value</th>
                    <th data-field="total_in_base_currency" data-sortable="true" data-width="120" data-width-unit="px">Value</th>
                    <th data-field="fees" data-sortable="true" data-width="100" data-width-unit="px">Fees</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in trades %}
                <tr>
                    <td class="text-nowrap">{{ trade.date }}<br><small class="fw-lighter">{{ trade.time }}</small></td>
                    <td>
                        {% if trade.buy_sell == "Buy" %}
                        <span class="green-pill">{{ trade.buy_sell }}</span>
                        {% else %}
                        <span class="red-pill">{{ trade.buy_sell }}</span>
                        {% endif %}
                        <br>
                        <small class="fw-lighter">{{ trade.transaction_type }}</small>
                    </td>
                    <td>{{ trade.symbol }}<br><small class="fw-lighter">{{ trade.name }}</small></td>
                    <td>{{ trade.price }}</td>
                    <td>{{ trade.quantity }}</td>
                    <td>{{ trade.total }}</td>
                    <td>{{ trade.total_in_base_currency }}</td>
                    <td>{{ trade.fees }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- TableExport dependencies -->
<script src="{% static 'tableexport.jquery.plugin/libs/FileSaver/FileSaver.min.js' %}"></script>
<script src="{% static 'tableexport.jquery.plugin/tableExport.min.js' %}"></script>
<!-- Bootstrap Table Extensions -->
<script src="{% static 'bootstrap-table/dist/extensions/export/bootstrap-table-export.min.js' %}"></script>
<script src="{% static 'bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js' %}"></script>

<script>
    $(document).ready(function() {
        // Function to calculate dynamic table height based on available screen space
        function calculateTableHeight() {
            var $table = $('#trades-table');
            var $scrollableArea = $('.scrollable-area');

            // Calculate the expected scrollable area height based on viewport
            var viewportHeight = $(window).height();
            var expectedScrollableHeight = viewportHeight - 100;
            var scrollableAreaTop = $scrollableArea.offset().top;
            var scrollableAreaBottom = scrollableAreaTop + expectedScrollableHeight;

            var $tableContainer = $table.data('bootstrap.table')
                ? $table.closest('.bootstrap-table')
                : $table.parent();

            var availableHeight;

            // If table is initialized, measure from the Bootstrap Table wrapper
            if ($table.data('bootstrap.table') && $tableContainer.length) {
                var bootstrapTableTop = $tableContainer.offset().top;
                availableHeight = scrollableAreaBottom - bootstrapTableTop;
            } else {
                // Fallback calculation for before initialization
                var tableContainerTop = $tableContainer.offset().top;
                availableHeight = scrollableAreaBottom - tableContainerTop - 55;
            }

            return Math.max(availableHeight, 400);
        }

        // Initialize Bootstrap Table with sticky-header extension
        var $table = $('#trades-table');
        var navbarHeight = $('.navbar').outerHeight() || 0;

        var tableHeight = calculateTableHeight();

        // Initialize table with all options including sticky-header
        $table.bootstrapTable({
            search: true,
            pagination: true,
            paginationLoop: false,
            pageList: [10, 25, 50, 100, 200, 'All'],
            paginationParts: ['pageInfo', 'pageList', 'pageSize'],
            pageSize: 10,
            sortable: true,
            sortOrder: 'desc',
            sortName: 'date',
            icons: 'icons',
            iconsPrefix: 'bi',
            fixedScroll: true,
            classes: 'table table-hover',
            showColumns: true,
            showExport: true,
            exportTypes: ['csv'],
            exportOptions: {
                fileName: 'trades_export',
                ignoreColumn: []
            },
            stickyHeader: true,
            stickyHeaderOffsetY: navbarHeight,
            height: tableHeight
        });

        // Recalculate height on window resize
        var resizeTimeout;
        $(window).on('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                var newHeight = calculateTableHeight();
                $table.bootstrapTable('resetView', { height: newHeight });
            }, 100);
        });

        // Remove overflow from scrollable-area to allow sticky positioning and recalculate height
        setTimeout(function() {
            $('.scrollable-area').css('overflow', 'visible');
            setTimeout(function() {
                var updatedHeight = calculateTableHeight();
                $table.bootstrapTable('resetView', { height: updatedHeight });
            }, 100);
        }, 300);

        // Fix dropdown positioning by triggering Popper recalculation
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'class') {
                    var $target = $(mutation.target);
                    if ($target.hasClass('dropdown-menu') && $target.hasClass('show')) {
                        // Trigger resize and scroll events to force Popper to recalculate position
                        setTimeout(function() {
                            window.dispatchEvent(new Event('resize'));
                        }, 10);
                        setTimeout(function() {
                            window.dispatchEvent(new Event('scroll'));
                        }, 20);
                    }
                }
            });
        });

        // Start observing after Bootstrap Table initializes
        setTimeout(function() {
            $('.bootstrap-table .dropdown-menu').each(function() {
                observer.observe(this, { attributes: true, attributeFilter: ['class'] });
            });
        }, 500);
    });
</script>
{% endblock %}
