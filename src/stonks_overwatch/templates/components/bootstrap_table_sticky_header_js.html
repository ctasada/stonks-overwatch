{% load static %}
<!-- TableExport dependencies -->
<script src="{% static 'tableexport.jquery.plugin/libs/FileSaver/FileSaver.min.js' %}"></script>
<script src="{% static 'tableexport.jquery.plugin/tableExport.min.js' %}"></script>
<!-- Bootstrap Table Extensions -->
<script src="{% static 'bootstrap-table/dist/extensions/export/bootstrap-table-export.min.js' %}"></script>
<script src="{% static 'bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js' %}"></script>

<!--
    Bootstrap Table Sticky Header Component

    Purpose: Initializes Bootstrap Table with sticky headers, search, pagination, export, and dynamic height calculation

    Required Parameters:
        - table_id: The HTML ID of the table element (e.g., 'trades-table')
        - export_filename: The name for exported CSV files (e.g., 'trades_export')

    Optional Parameters:
        - sort_name: Column name to sort by default (default: 'date')
        - min_height: Minimum table height in pixels (default: 400)
                      Pass a positive integer. Values < 400 are automatically increased to 400 to ensure
                      the table remains usable (enough space for header, pagination, and at least a few rows).

    Configuration:
        The table is initialized with the following features:
        - Search: Enabled (search box above table)
        - Pagination: Enabled with options [10, 25, 50, 100, 200, 'All']
        - Default page size: 10 rows
        - Sorting: Enabled, default sort by 'date' column descending
        - Column visibility toggle: Enabled
        - CSV Export: Enabled
        - Sticky header: Enabled (header stays visible when scrolling)
        - Dynamic height: Table height adjusts to available viewport space

    Usage:
        Include this component in your template's extra_js block:
        - Required: table_id='my-table' export_filename='my_export'
        - Optional: sort_name='date' min_height=600

        Example: See account_overview.html, deposits.html, fees.html, or trades.html
-->

<script>
    $(document).ready(function() {
        // Constants for height calculations
        var VIEWPORT_HEIGHT_OFFSET = 100; // Accounts for navbar, padding, and margins above scrollable area
        var TABLE_CONTAINER_PADDING = 55; // Accounts for page title, margins, and spacing below table container
        var DEFAULT_MIN_TABLE_HEIGHT = 400; // Default minimum table height

        // Parse and validate min_height parameter
        // Values < 400 are clamped to 400px to ensure table usability (header + pagination + content rows)
        // Values >= 400 are preserved as-is
        var parsedHeight = parseInt("{{ min_height|default:400|escapejs }}", 10);
        var MIN_TABLE_HEIGHT = (isNaN(parsedHeight) || parsedHeight < DEFAULT_MIN_TABLE_HEIGHT)
            ? DEFAULT_MIN_TABLE_HEIGHT
            : parsedHeight;

        // Function to calculate dynamic table height based on available screen space
        function calculateTableHeight() {
            var $table = $('#{{ table_id }}');
            var $scrollableArea = $('.scrollable-area');

            // Calculate the expected scrollable area height based on viewport
            var viewportHeight = $(window).height();
            var expectedScrollableHeight = viewportHeight - VIEWPORT_HEIGHT_OFFSET;
            var scrollableAreaTop = $scrollableArea.offset().top;
            var scrollableAreaBottom = scrollableAreaTop + expectedScrollableHeight;

            var $tableContainer = $table.data('bootstrap.table')
                ? $table.closest('.bootstrap-table')
                : $table.parent();

            var availableHeight;

            // If table is initialized, measure from the Bootstrap Table wrapper
            if ($table.data('bootstrap.table') && $tableContainer.length) {
                var bootstrapTableTop = $tableContainer.offset().top;
                availableHeight = scrollableAreaBottom - bootstrapTableTop;
            } else {
                // Fallback calculation for before initialization
                var tableContainerTop = $tableContainer.offset().top;
                availableHeight = scrollableAreaBottom - tableContainerTop - TABLE_CONTAINER_PADDING;
            }

            return Math.max(availableHeight, MIN_TABLE_HEIGHT);
        }

        // Initialize Bootstrap Table with sticky-header extension
        var $table = $('#{{ table_id }}');
        var navbarHeight = $('.navbar').outerHeight() || 0;

        var tableHeight = calculateTableHeight();

        // Initialize Bootstrap Table with all configuration options
        // This replaces the old data-* attributes that were previously on the table element
        $table.bootstrapTable({
            // Search & Filter
            search: true,                           // Enable search box

            // Pagination
            pagination: true,                       // Enable pagination
            paginationLoop: false,                  // Don't loop pagination (no wrap around)
            pageList: [10, 25, 50, 100, 200, 'All'], // Available page size options
            paginationParts: ['pageInfo', 'pageList', 'pageSize'], // Show page info, size selector, and list
            pageSize: 10,                           // Default page size

            // Sorting
            sortable: true,                         // Enable column sorting
            sortOrder: 'desc',                      // Default sort order (descending)
            sortName: '{{ sort_name|default:"date" }}', // Default sort column (configurable via sort_name parameter)

            // Icons (Bootstrap Icons)
            icons: 'icons',                         // Use icon set
            iconsPrefix: 'bi',                      // Bootstrap Icons prefix

            // Layout & Styling
            fixedScroll: true,                      // Fixed scroll behavior
            classes: 'table table-hover',           // Bootstrap table classes

            // Features
            showColumns: true,                      // Show column visibility toggle
            showExport: true,                       // Show export button
            exportTypes: ['csv'],                   // Export formats (CSV)
            exportOptions: {
                fileName: '{{ export_filename }}',  // Export filename (required parameter)
                ignoreColumn: []                    // Export all columns
            },

            // Sticky Header Extension
            stickyHeader: true,                     // Enable sticky header
            stickyHeaderOffsetY: navbarHeight,      // Offset for navbar

            // Dynamic Height
            height: tableHeight                     // Calculated dynamic height
        });

        // Recalculate height on window resize
        // Debounced to avoid excessive recalculations during continuous resize events
        var resizeTimeout;
        var resizeHandler = function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                var newHeight = calculateTableHeight();
                $table.bootstrapTable('resetView', { height: newHeight });
            }, 100); // 100ms debounce delay
        };
        $(window).on('resize', resizeHandler);

        // Recalculate height after initialization to ensure proper sizing
        // Delay is necessary because:
        // 1. Bootstrap Table needs time to complete its DOM manipulation (wrapping, adding controls)
        // 2. Browser needs time to calculate actual element positions after table initialization
        // 3. The table container's final offset().top is only accurate after full render
        // 300ms provides sufficient time for Bootstrap Table initialization + DOM layout completion
        setTimeout(function() {
            var updatedHeight = calculateTableHeight();
            $table.bootstrapTable('resetView', { height: updatedHeight });
        }, 300);

        // Fix dropdown positioning by triggering Popper recalculation
        var observer = new MutationObserver(function(mutations) {
            for (const mutation of mutations) {
                if (mutation.attributeName === 'class') {
                    var $target = $(mutation.target);
                    if ($target.hasClass('dropdown-menu') && $target.hasClass('show')) {
                        // Trigger resize and scroll events to force Popper to recalculate position
                        setTimeout(function() {
                            window.dispatchEvent(new Event('resize'));
                        }, 10);
                        setTimeout(function() {
                            window.dispatchEvent(new Event('scroll'));
                        }, 20);
                    }
                }
            }
        });

        // Function to clean up all observers and event handlers
        function cleanup() {
            // Disconnect dropdown observer
            if (observer && typeof observer.disconnect === 'function') {
                observer.disconnect();
                observer = null;
            }

            // Disconnect removal observer
            if (removalObserver && typeof removalObserver.disconnect === 'function') {
                removalObserver.disconnect();
                removalObserver = null;
            }

            // Remove resize event handler
            $(window).off('resize', resizeHandler);
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
                resizeTimeout = null;
            }
        }

        // Start observing after Bootstrap Table initializes
        // Delay is necessary to ensure:
        // 1. Bootstrap Table has completed DOM manipulation (creates dropdown-menu elements)
        // 2. All Bootstrap dropdowns are fully initialized
        // 3. The dropdown elements exist in the DOM before we attach observers
        // 500ms provides sufficient time for Bootstrap Table + Bootstrap dropdown initialization
        setTimeout(function() {
            $('.bootstrap-table .dropdown-menu').each(function() {
                observer.observe(this, { attributes: true, attributeFilter: ['class'] });
            });
        }, 500);

        // Cleanup: Disconnect observer on page unload
        $(window).on('beforeunload', function() {
            cleanup();
        });

        // Cleanup: Disconnect observer if table is destroyed
        $table.on('destroy.bs.table', function() {
            cleanup();
        });

        // Cleanup: Disconnect observer if table container is removed from DOM
        var $tableContainer = $table.closest('.bootstrap-table').length
            ? $table.closest('.bootstrap-table')
            : $table.parent();

        // Monitor for table removal using MutationObserver on parent
        var removalObserver = new MutationObserver(function(mutations) {
            for (const mutation of mutations) {
                for (const removedNode of mutation.removedNodes) {
                    // Check if removed node is the table itself, or contains the table (only for Element nodes)
                    if (removedNode === $table[0] ||
                        (removedNode.nodeType === 1 && typeof removedNode.contains === 'function' && removedNode.contains($table[0]))) {
                        cleanup();
                        return;
                    }
                }
            }
        });

        // Observe the parent container for table removal
        if ($tableContainer.length && $tableContainer[0].parentNode) {
            removalObserver.observe($tableContainer[0].parentNode, {
                childList: true,
                subtree: true
            });
        }
    });
</script>
