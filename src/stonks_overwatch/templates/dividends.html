{% extends 'base.html' %}
{% load custom_tags %}
{% load static %}
{% block content %}

<div class="container-fluid row-gap-5">
    {% if total_dividends == None%}
    <div class="row mt-2 column-gap-3">
        <h4 class="mb-1">No dividends found</h4>
    </div>
    {% else %}
    <div class="row mt-2 column-gap-3">
        <div class="col-md-auto border border-primary-subtle bg-light rounded mb-3">
            <label class="col-form-label-p-0 text-secondary">Total Dividends</label>
            <br>
            <span class="h5 fw-semibold text-success">{{ total_dividends }}</span>
        </div>
    </div>
    <div class="row border border-primary-subtle bg-light rounded mb-3">
        <div class="row mt-2">
            <div class="col">
                <h5 class="mb-1">Dividend Cash Flow</h5>
            </div>
            <div class="col float-end text-end">
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="dividendsTime" id="yearButton" autocomplete="off">
                    <label class="btn btn-outline-primary" for="yearButton">Year</label>

                    <input type="radio" class="btn-check" name="dividendsTime" id="monthButton" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="monthButton">Month</label>
                </div>
            </div>
        </div>
        <div id="chart-container" style="position: relative; width: 100%; height: 40vh;">
            <canvas id="dividends-growth"></canvas>
        </div>
    </div>
    {% include 'distribution_with_list.html' with chart_id="dividends-chart" items=dividendsDiversification.table %}
    <div class="row border border-primary-subtle bg-light rounded mb-3" style="background-color:#dbf5ff">
        <div class="row my-2">
            <div class="col-auto">
                <h5 class="my-1">Dividends Calendar</h5>
            </div>
            <div class="col-auto">
                <div class="dropdown btn-sm dropdown-custom" id="dividendsYearsDropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-custom" type="button" id="dividendsYearsDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                        {{ dividendsCalendar.years.0 }}
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dividendsYearsDropdownButton" style="min-width: 100%; width: auto;">
                        {% for year in dividendsCalendar.years %}
                        <li><a class="dropdown-item" href="#">{{ year }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% for key, value in dividendsCalendar.calendar.items %}
        <div class="col-sm-4 border">
            <div class="row-sm mt-1 fs-5">
                {{ key }}
            </div>
            <div class="row m-2">
                <div class="col text-left">
                    {{ value.payouts }} payouts
                </div>
                <div class="col-md-auto text-right border rounded-pill" style="background-color: #7386D5; color: white">
                    {{ value.formatedTotal }}
                </div>
            </div>
            {% if value.payouts > 0 %}
                <!-- When there's no Payout, there is no Day field, so skip the condition to avoid a silent error -->
                {% for day, dividends in value.days.items %}
                    {% for key, dividend in dividends.items %}
                        {% if dividend.change != 0 %}
                            {% if dividend.isUpcoming %}
                            <div class="row m-2 border rounded-pill upcoming-dividends">
                            {% else %}
                            <div class="row m-2 border rounded-pill dividends">
                            {% endif %}
                                <div class="col-sm-1 text-left">
                                    {{ day }}
                                </div>
                                <div class="col-sm-8 text-truncate">
                                    {{ dividend.stockName }}
                                </div>
                                <div class="col-sm-3 text-right">
                                    {{ dividend.formatedChange }}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
            </div>

            {% if forloop.counter|divisibleby:3 %}
            <!-- Force next columns to break to the new line at md breakpoint and up -->
            <div class="w-100 d-none d-md-block"></div>
            {% endif %}
        {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
<!-- ChartJS -->
<script src="{% static 'chart.js/dist/chart.umd.js' %}"></script>
<script src="{% static 'luxon/build/global/luxon.js' %}"></script>
<script src="{% static 'chartjs-adapter-luxon/dist/chartjs-adapter-luxon.umd.min.js' %}"></script>
<script src="{% static '@seahsky/chartjs-plugin-autocolors/dist/chartjs-plugin-autocolors.min.js' %}"></script>
{{ currencySymbol|json_script:"currency-symbol" }}
<script src="{% static 'js/distribution-char-utils.js' %}"></script>
<script>
    $('#yearButton').on('click', function () {
        drawDividends("Year")
    })
    $('#monthButton').on('click', function () {
        drawDividends("Month")
    })

    function getDividendsPerMonth() {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        return {
            labels: months,
            datasets: [
                {% for key, value in dividendsGrowth.items %}
                {
                    label: "{{ key }}",
                    data: {{ value }},
                    borderWidth: 1
                },
                {% endfor %}
            ]
        };
    }

    function getDividendsPerYear() {
        const values = []
        const years = []

        {% for year, data in dividendsGrowth.items %}
        {
            const sum = {{ data }}.reduce((acc, val) => acc + val, 0);
            years.push({{ year }})
            values.push(sum)
        }
        {% endfor %}

        return {
            labels: years,
            datasets: [
                {
                    data: values,
                    borderWidth: 1
                }
            ]
        };
    }

    function drawDividends(datatype) {
        const config = {
            type: 'bar',
            data: datatype === "Month" ? getDividendsPerMonth() : getDividendsPerYear(),
            plugins: [
                autocolors
            ],
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        display: false,
                        position: 'top',
                    },
                    title: {
                        display: false,
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';

                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            },
        }

        let chartStatus = Chart.getChart("dividends-growth"); // <canvas> id
        if (chartStatus !== undefined) {
            chartStatus.destroy();
        }

        new Chart(document.getElementById("dividends-growth").getContext("2d"), config);
    }

    drawDividends("Month")
    drawDoughnutChart(
        "dividends-chart",
        "Dividends",
        {{ dividendsDiversification.chart.labels|safe }},
        {{ dividendsDiversification.chart.values|safe }}
    );

    // Handle dividends year dropdown selection
    $('#dividendsYearsDropdown .dropdown-item').on('click', function(e) {
        e.preventDefault();
        // Remove active class from all items
        $('#dividendsYearsDropdown .dropdown-item').removeClass('active');
        // Add active class to clicked item
        $(this).addClass('active');
        // Update the dropdown button text
        $('#dividendsYearsDropdownButton').text($(this).text());
        
        // Get the selected year
        const selectedYear = $(this).text();
        console.log('Selected year:', selectedYear);
        
        // TODO: Add your custom logic here to handle the year selection
        // For example, you could filter the dividends calendar to show only the selected year
    });
</script>
{% endblock %}