{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Stonks Overwatch</title>

    <link rel="icon" type="image/png" href="{%  static 'stonks_overwatch-32x32.png' %}" sizes="32x32">

    <!-- jQuery CDN - Full version -->
    <script src="{% static 'jquery/dist/jquery.min.js' %}"></script>

    <!-- Bootstrap CSS CDN -->
    <link href="{% static 'bootstrap/dist/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'bootstrap-icons/font/bootstrap-icons.css' %}" rel="stylesheet">

    <!-- Bootstrap Table CSS -->
    <link href="{% static 'bootstrap-table/dist/bootstrap-table.min.css' %}" rel="stylesheet">
    <link href="{% static 'bootstrap-table/dist/themes/bootstrap-table/bootstrap-table.min.css' %}" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">

    {% block extra_css %}{% endblock %}

    <!-- Inline script to prevent sidebar flash - runs before DOM is rendered -->
    <script>
        (function() {
            // Check localStorage immediately when head loads
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                // Add CSS to immediately apply collapsed state before page renders
                document.documentElement.style.setProperty('--sidebar-immediate-state', 'sidebar-collapsed');
            }
        })();
    </script>
</head>

<body>
    <div class="container-fluid">
        <div class="row flex-nowrap">
            <!-- Sidebar Navigation -->
            <div class="col-auto px-0 sticky-top" id="sidebar">
                <nav class="navbar navbar-expand-sm navbar-dark bg-primary flex-column sticky-top min-vh-100 px-0 py-0" aria-label="Sidebar navigation">
                    <!-- Brand/Title with Toggle -->
                    <div class="navbar-brand d-flex align-items-center py-3 border-bottom border-light border-opacity-25 w-100 position-relative">
                        <!-- Toggle Button -->
                        <button class="btn btn-sm btn-light position-absolute sidebar-toggle" id="sidebarToggle" type="button" aria-label="Toggle sidebar">
                            <i class="bi bi-chevron-left text-primary"></i>
                        </button>
                        <img src="{% static 'stonks_overwatch.png' %}" alt="Stonks Overwatch Logo" class="me-3 sidebar-icon sidebar-logo" width="48" height="48">
                        <div class="sidebar-text fw-semibold text-center">
                            <div class="fs-6 lh-1">Stonks</div>
                            <div class="fs-6 lh-1">Overwatch</div>
                        </div>
                    </div>

                    <!-- Portfolio Selector -->
                    <div class="px-2 py-1 border-bottom border-light border-opacity-25 w-100">
                        <div class="dropdown" id="sidebar-portfolio-selector">
                            <button class="sidebar-nav-link dropdown-toggle w-100 text-start d-flex align-items-center py-2" id="selectPortfolio" data-bs-toggle="dropdown" aria-expanded="false" data-bs-placement="right" title="Select Portfolio" data-tooltip-text="Select Portfolio">
                                <!-- The JScript block injects the selected portfolio via a GET Request -->
                            </button>
                            <ul class="dropdown-menu w-100 shadow" id="sidebar-portfolio-menu">
                                <!-- The JScript block injects the list of portfolios via a GET Request -->
                            </ul>
                        </div>
                    </div>

                    <!-- Navigation Links -->
                    <div class="navbar-nav flex-column w-100 px-2 py-2">
                        {% url 'dashboard' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="dashboard" data-bs-toggle="tooltip" data-bs-placement="right" title="Dashboard">
                            <i class="bi bi-graph-up me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Dashboard</span>
                        </a>

                        {% url 'portfolio' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="portfolio" data-bs-toggle="tooltip" data-bs-placement="right" title="Portfolio">
                            <i class="bi bi-briefcase-fill me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Portfolio</span>
                        </a>

                        {% url 'diversification' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="diversification" data-bs-toggle="tooltip" data-bs-placement="right" title="Diversification">
                            <i class="bi bi-pie-chart-fill me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Diversification</span>
                        </a>

                        {% url 'dividends' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="dividends" data-bs-toggle="tooltip" data-bs-placement="right" title="Dividends">
                            <i class="bi bi-cash-coin me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Dividends</span>
                        </a>

                        {% url 'fees' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="fees" data-bs-toggle="tooltip" data-bs-placement="right" title="Fees">
                            <i class="bi bi-receipt me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Fees</span>
                        </a>

                        {% url 'deposits' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="deposits" data-bs-toggle="tooltip" data-bs-placement="right" title="Deposits">
                            <i class="bi bi-piggy-bank-fill me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Deposits</span>
                        </a>

                        {% url 'transactions' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="transactions" data-bs-toggle="tooltip" data-bs-placement="right" title="Transactions">
                            <i class="bi bi-arrow-left-right me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Transactions</span>
                        </a>

                        {% url 'account_overview' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="account_overview" data-bs-toggle="tooltip" data-bs-placement="right" title="Account Statement">
                            <i class="bi bi-bank me-3 fs-5 sidebar-icon align-self-start"></i>
                            <span class="sidebar-text">
                                <span class="d-block">Account</span>
                                <span class="d-block">Statement</span>
                            </span>
                        </a>
                    </div>

                    <!-- Sticky Bottom Section -->
                    <div class="d-flex flex-column w-100 mt-auto">
                        <!-- Settings Dropdown Menu Entry -->
                        <div class="dropdown px-2 py-1 border-top border-light border-opacity-25 w-100" id="sidebar-settings-selector">
                            <a href="#" class="sidebar-nav-link dropdown-toggle w-100 text-start d-flex align-items-center py-2"
                               id="select-settings" data-bs-toggle="dropdown" aria-expanded="false" data-bs-popper-config='{"placement":"right","modifiers":[{"name":"offset","options":{"offset":[0,2]}}]}' title="Configuration" data-tooltip-text="Configuration">
                                <i class="bi bi-gear fs-5 sidebar-icon me-3"></i>
                                <span class="sidebar-text">Configuration</span>
                            </a>
                            <ul class="dropdown-menu shadow" id="sidebar-settings-menu" aria-labelledby="select-settings">
                                <li>
                                    <a class="dropdown-item d-flex align-items-center" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
                                        <i class="bi bi-sliders me-2"></i> Settings
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item d-flex align-items-center" href="#" data-bs-toggle="modal" data-bs-target="#releaseNotesModal">
                                        <i class="bi bi-journal-text me-2"></i> Release Notes
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item d-flex align-items-center" href="{{ STONKS_OVERWATCH_SUPPORT_URL }}" target="_blank" rel="noopener">
                                        <i class="bi bi-bug me-2"></i> Bug Report / Feedback
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <!-- Connection Status -->
                        <div class="px-3 pt-3 pb-1 border-top border-light border-opacity-25 w-100">
                            {% is_connected_to_degiro as is_degiro_connected %}
                            {% get_connected_tooltip as get_connected_tooltip %}
                            <div class="d-flex align-items-center text-white" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-html="true" title="{{ get_connected_tooltip }}">
                                {%  if is_degiro_connected %}
                                    <i class="bi-cloud-check-fill me-3 fs-5 text-success sidebar-icon"></i>
                                    <span class="small sidebar-text">Connected</span>
                                {% else %}
                                    <i class="bi-cloud-slash-fill me-3 fs-5 text-warning sidebar-icon"></i>
                                    <span class="small sidebar-text">Disconnected</span>
                                {% endif %}
                            </div>
                        </div>
                        <!-- App Version at Bottom -->
                        <div class="text-center text-white-50 small px-3 pb-2">
                            v{{ VERSION }}
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col py-3" id="content">
                <!-- Top Navigation Bar -->
                <nav class="navbar navbar-expand-lg navbar-light bg-light" aria-label="Top navigation">
                    <div class="container-fluid justify-content-start">
                        <!-- Shows Total Portfolio -->
                        {% show_total_portfolio %}
                    </div>
                </nav>

                <div class="scrollable-area" style="height: calc(100vh - 100px)">
                    {% block content %}
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="{% static 'bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
    <!-- Bootstrap Table JS -->
    <script src="{% static 'bootstrap-table/dist/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'bootstrap-table/dist/themes/bootstrap-table/bootstrap-table.min.js' %}"></script>
    <!-- Modal utilities and Settings -->
    <script src="{% static 'js/modal-utils.js' %}"></script>
    <script src="{% static 'js/settings.js' %}"></script>

    <script type="text/javascript">
        // Tooltip message for unstable portfolios
        const IN_DEVELOPMENT_MSG = 'is in development';
        // Wrench emoji HTML for unstable portfolios (no custom class, just Bootstrap)
        const WRENCH_HTML = '<span class="ms-2 float-end">üß™Ô∏è</span>';

        let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        let tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            const tooltip = new bootstrap.Tooltip(tooltipTriggerEl);
            // Disable navigation tooltips initially (sidebar starts expanded)
            if (tooltipTriggerEl.classList.contains('sidebar-nav-link')) {
                tooltip.disable();
            }
            return tooltip;
        });

        // Fetch configuration data
        fetch("{% url 'configuration' %}", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => response.json())
            .then(data => {
                const selectedPortfolio = document.getElementById("selectPortfolio");
                // Always keep dropdown functionality
                selectedPortfolio.setAttribute("data-bs-toggle", "dropdown");
                selectedPortfolio.setAttribute("aria-expanded", "false");
                selectedPortfolio.classList.add("dropdown-toggle");
                selectedPortfolio.classList.remove("non-clickable");

                // Consistent stability check: treat as stable unless stable is explicitly false
                const selectedStable = data.selected_portfolio.stable !== false;
                let selectedPortfolioHTML = `<img src="${data.selected_portfolio.logo}" alt="${data.selected_portfolio.id}" width="25" height="25" class="rounded-circle me-2 sidebar-icon flex-shrink-0"><span class="sidebar-text">${data.selected_portfolio.name}</span>`;
                if (!selectedStable) {
                    selectedPortfolioHTML += WRENCH_HTML;
                    selectedPortfolio.setAttribute("title", `${data.selected_portfolio.name} ${IN_DEVELOPMENT_MSG}`);
                    // Initialize tooltip for selectPortfolio
                    if (!bootstrap.Tooltip.getInstance(selectedPortfolio)) {
                        new bootstrap.Tooltip(selectedPortfolio);
                    }
                } else {
                    selectedPortfolio.removeAttribute("title");
                    const tooltipInstance = bootstrap.Tooltip.getInstance(selectedPortfolio);
                    if (tooltipInstance) tooltipInstance.dispose();
                }
                selectedPortfolio.innerHTML = selectedPortfolioHTML;

                const portfolioMenu = document.getElementById("sidebar-portfolio-menu");
                portfolioMenu.innerHTML = ""; // Clear existing menu items

                if (data.available_portfolios.length === 1) {
                    // Remove the dropdown toggle if there is only one portfolio
                    selectedPortfolio.removeAttribute("data-bs-toggle");
                    selectedPortfolio.removeAttribute("aria-expanded");
                    selectedPortfolio.classList.remove("dropdown-toggle");
                    selectedPortfolio.classList.add("non-clickable");
                } else {
                    // Show the portfolio selector dropdown only when there are multiple portfolios
                    data.available_portfolios.forEach(portfolio => {
                        const menuItem = document.createElement("li");
                        // Consistent stability check for each portfolio
                        const isStable = portfolio.stable !== false;
                        const tooltipAttrs = !isStable ? ` data-bs-toggle=\"tooltip\" title=\"${portfolio.name} ${IN_DEVELOPMENT_MSG}\"` : '';
                        const menuItemHTML = `
                            <a class="dropdown-item portfolio-link-filter d-flex align-items-center justify-content-between" href="#" data-value="${portfolio.id}"${tooltipAttrs}>
                                <span>
                                    <img src="${portfolio.logo}" alt="${portfolio.id}" width="25" height="25" class="rounded-circle me-2">
                                    ${portfolio.name}
                                </span>
                                ${!isStable ? WRENCH_HTML : ''}
                            </a>
                        `;
                        menuItem.innerHTML = menuItemHTML;

                        // Add click event listener to menuItem
                        menuItem.querySelector("a").addEventListener("click", function(event) {
                            event.preventDefault();  // Prevent default link behavior

                            let selectedPortfolio = this.getAttribute("data-value");

                            fetch("{% url 'configuration' %}", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                                body: JSON.stringify({ selected_portfolio: selectedPortfolio })
                            }).then(response => {
                                if (response.ok) {
                                    window.location.reload();
                                }
                            });
                        });

                        portfolioMenu.appendChild(menuItem);
                    });
                }

                // Initialize tooltips for new elements
                const newTooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                newTooltipTriggerList.forEach(function (tooltipTriggerEl) {
                    if (!bootstrap.Tooltip.getInstance(tooltipTriggerEl)) {
                        new bootstrap.Tooltip(tooltipTriggerEl);
                    }
                });

                // Restore sidebar state after portfolio data is loaded
                restoreSidebarState();
            });

        // Set active navigation state
        function setActiveNavigation() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.sidebar-nav-link');

            navLinks.forEach(link => {
                link.classList.remove('active', 'bg-light', 'bg-opacity-25');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active', 'bg-light', 'bg-opacity-25');
                }
            });
        }

        // Set active navigation on page load
        setActiveNavigation();

        // Restore sidebar state immediately (DOM is already ready since script is at bottom)
        // This ensures sidebar state is restored even if portfolio fetch fails
        restoreSidebarState();

        // Sidebar collapse/expand functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            const toggleIcon = toggleButton.querySelector('i');
            const portfolioButton = document.getElementById('selectPortfolio');

            sidebar.classList.toggle('sidebar-collapsed');

            // Save sidebar state to localStorage
            const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed.toString());

            // Change toggle button icon
            if (isCollapsed) {
                toggleIcon.className = 'bi bi-chevron-right text-primary';

                // Enable tooltips for collapsed state
                enableTooltipsForCollapsedSidebar();

                // Handle portfolio selector tooltip
                if (portfolioButton && portfolioButton.getAttribute('data-tooltip-text')) {
                    portfolioButton.setAttribute('data-bs-toggle-tooltip', 'tooltip');
                    portfolioButton.setAttribute('data-bs-placement', 'right');
                    portfolioButton.setAttribute('title', portfolioButton.getAttribute('data-tooltip-text'));
                    // Initialize tooltip for portfolio button
                    const portfolioTooltip = new bootstrap.Tooltip(portfolioButton);
                    portfolioButton._tooltip = portfolioTooltip; // Store reference for later cleanup
                }
            } else {
                toggleIcon.className = 'bi bi-chevron-left text-primary';

                // Disable tooltips for expanded state
                disableTooltipsForExpandedSidebar();

                // Remove portfolio selector tooltip
                if (portfolioButton) {
                    const tooltipInstance = portfolioButton._tooltip || bootstrap.Tooltip.getInstance(portfolioButton);
                    if (tooltipInstance) {
                        tooltipInstance.dispose();
                        portfolioButton._tooltip = null;
                    }
                    portfolioButton.removeAttribute('data-bs-toggle-tooltip');
                    portfolioButton.removeAttribute('title');
                }
            }
        }

        // Restore sidebar state from localStorage
        function restoreSidebarState() {
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed');
            const sidebar = document.getElementById('sidebar');

            // Clean up the immediate state CSS custom property since JavaScript is now handling it
            if (document.documentElement.style.getPropertyValue('--sidebar-immediate-state')) {
                document.documentElement.style.removeProperty('--sidebar-immediate-state');
            }

            // Apply collapsed state if needed
            if (sidebarCollapsed === 'true') {
                const toggleButton = document.getElementById('sidebarToggle');
                const toggleIcon = toggleButton?.querySelector('i');
                const portfolioButton = document.getElementById('selectPortfolio');

                if (sidebar && !sidebar.classList.contains('sidebar-collapsed')) {
                    sidebar.classList.add('sidebar-collapsed');
                }
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-right text-primary';

                // Enable tooltips for collapsed state
                enableTooltipsForCollapsedSidebar();

                // Handle portfolio selector tooltip
                if (portfolioButton && portfolioButton.getAttribute('data-tooltip-text')) {
                    portfolioButton.setAttribute('data-bs-toggle-tooltip', 'tooltip');
                    portfolioButton.setAttribute('data-bs-placement', 'right');
                    portfolioButton.setAttribute('title', portfolioButton.getAttribute('data-tooltip-text'));
                    // Initialize tooltip for portfolio button
                    const portfolioTooltip = new bootstrap.Tooltip(portfolioButton);
                    portfolioButton._tooltip = portfolioTooltip; // Store reference for later cleanup
                }
            }
        }

        // Enable tooltips when sidebar is collapsed
        function enableTooltipsForCollapsedSidebar() {
            const navLinks = document.querySelectorAll('.sidebar-nav-link[data-bs-toggle="tooltip"]');
            navLinks.forEach(link => {
                const tooltipInstance = bootstrap.Tooltip.getInstance(link);
                if (tooltipInstance) {
                    tooltipInstance.enable();
                }
            });
        }

        // Disable tooltips when sidebar is expanded
        function disableTooltipsForExpandedSidebar() {
            const navLinks = document.querySelectorAll('.sidebar-nav-link[data-bs-toggle="tooltip"]');
            navLinks.forEach(link => {
                const tooltipInstance = bootstrap.Tooltip.getInstance(link);
                if (tooltipInstance) {
                    tooltipInstance.disable();
                }
            });
        }

        // Add event listener to toggle button
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);

        // Ensure settings dropdown opens to the right
        // Bootstrap will auto-initialize, but we need to update Popper config after initialization
        setTimeout(function() {
            const settingsDropdownElement = document.getElementById('select-settings');
            if (settingsDropdownElement) {
                const dropdownInstance = bootstrap.Dropdown.getInstance(settingsDropdownElement);
                if (dropdownInstance && dropdownInstance._popper) {
                    // Update Popper placement
                    dropdownInstance._popper.setOptions({
                        placement: 'right',
                        modifiers: [
                                {
                                name: 'offset',
                                options: {
                                    offset: [0, 2]
                                }
                            }
                        ]
                    });
                }
            }
        }, 100);
    </script>

    <!-- Release Notes Modal -->
    <div class="modal fade" id="releaseNotesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 0;">
                    <!-- Content will be loaded via AJAX -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold"><i class="bi bi-sliders me-2"></i>Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 0;">
                    <!-- Content will be loaded via AJAX -->
                </div>
                <div class="modal-footer border-0 pt-3">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="settings-save-btn" onclick="saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Release Notes Modal - Initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const releaseNotesModal = document.getElementById('releaseNotesModal');
            if (releaseNotesModal) {
                releaseNotesModal.addEventListener('show.bs.modal', function() {
                    const modalBody = this.querySelector('.modal-body');

                    // Only load if content is not already loaded
                    if (!modalBody.dataset.loaded) {
                        modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                        const releaseNotesUrl = "{% url 'release_notes' %}?dark_mode=0";

                        fetch(releaseNotesUrl, {
                            method: "GET",
                            headers: {
                                "Accept": "text/html",
                                "X-Requested-With": "XMLHttpRequest"
                            }
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.text();
                            })
                            .then(html => {
                                modalBody.innerHTML = html;
                                modalBody.dataset.loaded = 'true';
                            })
                            .catch(error => {
                                console.error('Error loading release notes:', error);
                                modalBody.innerHTML = '<div class="alert alert-danger">Failed to load release notes. Please try again later.</div>';
                            });
                    }
                });
            }

            // Settings Modal - Initialize after DOM is ready
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.addEventListener('show.bs.modal', function() {
                    const modalBody = this.querySelector('.modal-body');
                    const settingsUrl = "{% url 'settings' %}";

                    ModalScriptExecutor.loadModalContent(settingsUrl, modalBody, {
                        onSuccess: () => {
                            if (typeof initializeSettingsContent === 'function') {
                                initializeSettingsContent();
                            }
                        }
                    });
                });

                // Clean up timers when modal is hidden
                settingsModal.addEventListener('hidden.bs.modal', function() {
                    if (typeof clearVerificationTimers === 'function') {
                        clearVerificationTimers();
                    }
                    const modalBody = this.querySelector('.modal-body');
                    if (modalBody) {
                        modalBody.innerHTML = '';
                    }
                });
            }
        });

        // Helper function to show Bootstrap alerts
        function showBootstrapAlert(message, type = 'info', container = null) {
            return BootstrapAlertHelper.show(message, type, { container });
        }

        /**
         * Handle file selection and extract the full path
         * @param {HTMLInputElement} fileInput - The file input element
         * @param {string} pathInputId - The ID of the text input to populate with the path
         */
        function handleFileSelect(fileInput, pathInputId) {
            const pathInput = document.getElementById(pathInputId);
            if (!fileInput.files || fileInput.files.length === 0 || !pathInput) return;

            const file = fileInput.files[0];

            // Try every possible property to get the full path
            // Log all available properties for debugging
            console.log('File object properties:', Object.keys(file));
            console.log('File.path:', file.path);
            console.log('File.webkitRelativePath:', file.webkitRelativePath);
            console.log('File.mozFullPath:', file.mozFullPath);

            // Try to get full path from various properties
            let fullPath = null;

            // Try .path first (available in Electron/native apps)
            if (file.path && file.path !== '') {
                fullPath = file.path;
                console.log('Got path from file.path:', fullPath);
            }
            // Try webkitRelativePath
            else if (file.webkitRelativePath && file.webkitRelativePath !== '') {
                fullPath = file.webkitRelativePath;
                console.log('Got path from file.webkitRelativePath:', fullPath);
            }
            // Try mozFullPath (Firefox)
            else if (file.mozFullPath && file.mozFullPath !== '') {
                fullPath = file.mozFullPath;
                console.log('Got path from file.mozFullPath:', fullPath);
            }

            if (fullPath) {
                // Successfully got full path
                pathInput.value = fullPath;
                console.log('‚úì Full path extracted:', fullPath);
                BootstrapAlertHelper.success('‚úì Full path: ' + fullPath);
            } else {
                // Could not get full path, only have filename - this is normal in browsers
                console.log('‚ö† Browser security: only filename available. User needs to complete path.');
                // Keep current value if it looks like a path, otherwise just use filename
                const currentValue = pathInput.value.trim();
                if (!currentValue || currentValue === file.name) {
                    pathInput.value = file.name;
                } else {
                    // Replace just the filename in existing path
                    const lastSlash = currentValue.lastIndexOf('/');
                    if (lastSlash > 0) {
                        pathInput.value = currentValue.substring(0, lastSlash + 1) + file.name;
                    } else {
                        pathInput.value = file.name;
                    }
                }
                // Focus and select so user can easily edit
                pathInput.focus();
                pathInput.select();
            }
        }

        /**
         * Load key file content into textarea
         */
        function loadKeyFromFile(fileInput, textareaId) {
            const textarea = document.getElementById(textareaId);
            const container = document.getElementById(textareaId + '-container');
            const toggleButton = document.getElementById(textareaId + '-toggle');
            const statusBadge = document.getElementById(textareaId + '-status');
            const infoElement = document.getElementById(textareaId + '-info');

            if (!fileInput.files || fileInput.files.length === 0 || !textarea) return;

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const content = e.target.result;
                textarea.value = content;

                // Show the container if it was hidden
                if (container) {
                    container.style.display = 'block';
                }

                // Update toggle button
                if (toggleButton) {
                    toggleButton.innerHTML = '<i class="bi bi-eye-slash"></i> Hide';
                }

                // Update status badge
                if (statusBadge) {
                    statusBadge.style.backgroundColor = '#28a745';
                    statusBadge.style.color = '#fff';
                    statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> Loaded';
                }

                // Update info text
                if (infoElement) {
                    infoElement.innerHTML = '<i class="bi bi-info-circle"></i> ' + content.length + ' characters';
                }

                // Validate the key
                validateKey(textareaId);

                console.log('‚úì Key loaded from file:', file.name);
                BootstrapAlertHelper.success('‚úì Key loaded: ' + file.name);
            };

            reader.onerror = function() {
                console.error('‚úó Error reading file:', file.name);
                BootstrapAlertHelper.error('‚úó Error reading file: ' + file.name);
            };

            reader.readAsText(file);
        }

        /**
         * Toggle visibility of key textarea container
         */
        function toggleKeyVisibility(containerId, toggleButtonId) {
            const container = document.getElementById(containerId);
            const toggleButton = document.getElementById(toggleButtonId);
            if (!container) return;

            if (container.style.display === 'none') {
                container.style.display = 'block';
                if (toggleButton) {
                    toggleButton.innerHTML = '<i class="bi bi-eye-slash"></i> Hide';
                }
            } else {
                container.style.display = 'none';
                if (toggleButton) {
                    toggleButton.innerHTML = '<i class="bi bi-eye"></i> Show';
                }
            }
        }

        /**
         * Clear key content
         */
        function clearKey(textareaId) {
            const textarea = document.getElementById(textareaId);
            const statusBadge = document.getElementById(textareaId + '-status');
            const infoElement = document.getElementById(textareaId + '-info');
            const container = document.getElementById(textareaId + '-container');
            const toggleButton = document.getElementById(textareaId + '-toggle');

            if (!textarea) return;

            // Confirm before clearing
            if (textarea.value && !confirm('Are you sure you want to clear this key?')) {
                return;
            }

            textarea.value = '';
            textarea.classList.remove('is-valid', 'is-invalid');

            // Update status badge
            if (statusBadge) {
                statusBadge.style.backgroundColor = '#6c757d';
                statusBadge.style.color = '#fff';
                statusBadge.innerHTML = '<i class="bi bi-dash-circle"></i> Not Set';
            }

            // Clear info text
            if (infoElement) {
                infoElement.innerHTML = '';
            }

            // Hide container
            if (container) {
                container.style.display = 'none';
            }

            // Update toggle button
            if (toggleButton) {
                toggleButton.innerHTML = '<i class="bi bi-eye"></i> Show';
            }

            console.log('‚úì Key cleared');
            BootstrapAlertHelper.info('Key cleared');
        }

        /**
         * Validate key content
         */
        function validateKey(textareaId) {
            const textarea = document.getElementById(textareaId);
            const infoElement = document.getElementById(textareaId + '-info');
            if (!textarea) return;

            const content = textarea.value.trim();
            const isValid = content.includes('-----BEGIN') && content.includes('-----END');

            // Update visual feedback
            if (content.length === 0) {
                textarea.classList.remove('is-valid', 'is-invalid');
            } else if (isValid) {
                textarea.classList.remove('is-invalid');
                textarea.classList.add('is-valid');
            } else {
                textarea.classList.remove('is-valid');
                textarea.classList.add('is-invalid');
            }

            // Update info text
            if (infoElement && content.length > 0) {
                const icon = isValid ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-exclamation-circle text-danger"></i>';
                infoElement.innerHTML = icon + ' ' + content.length + ' characters';
            }
        }

        /**
         * Global function to save settings (called from settings_content.html)
         * Returns a JSON string (WKWebView doesn't support returning objects)
         * Format: '{"success": true/false, "message": "..."}'
         * This allows both the modal and native app dialog to handle save completion
         */
        async function saveSettings() {
            const activeBroker = document.querySelector('.broker-item.active');
            if (!activeBroker) {
                BootstrapAlertHelper.warning('Please select a broker');
                return JSON.stringify({ success: false, message: 'No broker selected' });
            }

            const brokerName = activeBroker.getAttribute('data-broker');
            let payload = {
                broker_name: brokerName
            };

            if (brokerName === 'degiro') {
                const usernameEl = document.getElementById('degiro-username');
                const passwordEl = document.getElementById('degiro-password');
                const totpEl = document.getElementById('degiro-totp');
                const updateFreqEl = document.getElementById('degiro-update-frequency');

                if (!usernameEl || !passwordEl || !totpEl || !updateFreqEl) {
                    BootstrapAlertHelper.error('<strong>Error:</strong> DEGIRO configuration elements not found');
                    return JSON.stringify({ success: false, message: 'DEGIRO configuration elements not found' });
                }

                // DEGIRO enabled checkbox is disabled (read-only), don't send it
                payload.credentials = {
                    username: usernameEl.value,
                    password: passwordEl.value,
                    totp_secret_key: totpEl.value
                };
                payload.update_frequency = parseInt(updateFreqEl.value);
            } else if (brokerName === 'bitvavo') {
                const enabledEl = document.getElementById('bitvavo-enabled');
                const apikeyEl = document.getElementById('bitvavo-apikey');
                const apisecretEl = document.getElementById('bitvavo-apisecret');
                const updateFreqEl = document.getElementById('bitvavo-update-frequency');

                if (!enabledEl || !apikeyEl || !apisecretEl || !updateFreqEl) {
                    BootstrapAlertHelper.error('<strong>Error:</strong> Bitvavo configuration elements not found');
                    return JSON.stringify({ success: false, message: 'Bitvavo configuration elements not found' });
                }

                payload.enabled = enabledEl.checked;
                payload.credentials = {
                    apikey: apikeyEl.value,
                    apisecret: apisecretEl.value
                };
                payload.update_frequency = parseInt(updateFreqEl.value);
            } else if (brokerName === 'ibkr') {
                const enabledEl = document.getElementById('ibkr-enabled');
                const accessTokenEl = document.getElementById('ibkr-access-token');
                const accessTokenSecretEl = document.getElementById('ibkr-access-token-secret');
                const consumerKeyEl = document.getElementById('ibkr-consumer-key');
                const dhPrimeEl = document.getElementById('ibkr-dh-prime');
                const encryptionKeyEl = document.getElementById('ibkr-encryption-key');
                const signatureKeyEl = document.getElementById('ibkr-signature-key');
                const updateFreqEl = document.getElementById('ibkr-update-frequency');

                if (!enabledEl || !accessTokenEl || !accessTokenSecretEl || !consumerKeyEl || !dhPrimeEl || !encryptionKeyEl || !signatureKeyEl || !updateFreqEl) {
                    BootstrapAlertHelper.error('<strong>Error:</strong> IBKR configuration elements not found');
                    return JSON.stringify({ success: false, message: 'IBKR configuration elements not found' });
                }

                payload.enabled = enabledEl.checked;
                payload.credentials = {
                    access_token: accessTokenEl.value,
                    access_token_secret: accessTokenSecretEl.value,
                    consumer_key: consumerKeyEl.value,
                    dh_prime: dhPrimeEl.value,
                    encryption_key: encryptionKeyEl.value || null,
                    signature_key: signatureKeyEl.value || null
                };
                payload.update_frequency = parseInt(updateFreqEl.value);
            }

            try {
                const response = await fetch("{% url 'settings' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    BootstrapAlertHelper.success('<strong>Success!</strong> Configuration saved successfully.');
                    return JSON.stringify({ success: true, message: 'Configuration saved successfully' });
                } else {
                    const errorMsg = data.error || 'Failed to save configuration';
                    BootstrapAlertHelper.error('<strong>Error:</strong> ' + errorMsg);
                    return JSON.stringify({ success: false, message: errorMsg });
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                const errorMsg = 'Failed to save configuration. Please try again.';
                BootstrapAlertHelper.error('<strong>Error:</strong> ' + errorMsg);
                return JSON.stringify({ success: false, message: errorMsg });
            }
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>
