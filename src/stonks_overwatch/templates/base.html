{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Stonks Overwatch</title>

    <link rel="icon" type="image/png" href="{%  static 'stonks_overwatch-32x32.png' %}" sizes="32x32">

    <!-- jQuery CDN - Full version -->
    <script src="{% static 'jquery/dist/jquery.min.js' %}"></script>

    <!-- Bootstrap CSS CDN -->
    <link href="{% static 'bootstrap/dist/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'bootstrap-icons/font/bootstrap-icons.css' %}" rel="stylesheet">

    <!-- Bootstrap Table CSS -->
    <link href="{% static 'bootstrap-table/dist/bootstrap-table.min.css' %}" rel="stylesheet">
    <link href="{% static 'bootstrap-table/dist/themes/bootstrap-table/bootstrap-table.min.css' %}" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">

    <!-- Inline script to prevent sidebar flash - runs before DOM is rendered -->
    <script>
        (function() {
            // Check localStorage immediately when head loads
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                // Add CSS to immediately apply collapsed state before page renders
                document.documentElement.style.setProperty('--sidebar-immediate-state', 'sidebar-collapsed');
            }
        })();
    </script>
</head>

<body>
    <div class="container-fluid">
        <div class="row flex-nowrap">
            <!-- Sidebar Navigation -->
            <div class="col-auto px-0 sticky-top" id="sidebar">
                <nav class="navbar navbar-expand-sm navbar-dark bg-primary flex-column sticky-top min-vh-100 px-0 py-0" aria-label="Sidebar navigation">
                    <!-- Brand/Title with Toggle -->
                    <div class="navbar-brand d-flex align-items-center py-3 border-bottom border-light border-opacity-25 w-100 position-relative">
                        <!-- Toggle Button -->
                        <button class="btn btn-sm btn-light position-absolute sidebar-toggle" id="sidebarToggle" type="button" aria-label="Toggle sidebar">
                            <i class="bi bi-chevron-left text-primary"></i>
                        </button>
                        <img src="{% static 'stonks_overwatch.png' %}" alt="Stonks Overwatch Logo" class="me-3 sidebar-icon sidebar-logo" width="48" height="48">
                        <div class="sidebar-text fw-semibold text-center">
                            <div class="fs-6 lh-1">Stonks</div>
                            <div class="fs-6 lh-1">Overwatch</div>
                        </div>
                    </div>

                    <!-- Portfolio Selector -->
                    <div class="px-2 py-1 border-bottom border-light border-opacity-25 w-100">
                        <div class="dropdown" id="sidebar-portfolio-selector">
                            <button class="sidebar-nav-link dropdown-toggle w-100 text-start d-flex align-items-center py-2" id="selectPortfolio" data-bs-toggle="dropdown" aria-expanded="false" data-bs-placement="right" title="Select Portfolio" data-tooltip-text="Select Portfolio">
                                <!-- The JScript block injects the selected portfolio via a GET Request -->
                            </button>
                            <ul class="dropdown-menu w-100 shadow" id="sidebar-portfolio-menu">
                                <!-- The JScript block injects the list of portfolios via a GET Request -->
                            </ul>
                        </div>
                    </div>

                    <!-- Navigation Links -->
                    <div class="navbar-nav flex-column w-100 px-2 py-2">
                        {% url 'dashboard' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="dashboard" data-bs-toggle="tooltip" data-bs-placement="right" title="Dashboard">
                            <i class="bi bi-graph-up me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Dashboard</span>
                        </a>

                        {% url 'portfolio' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="portfolio" data-bs-toggle="tooltip" data-bs-placement="right" title="Portfolio">
                            <i class="bi bi-briefcase-fill me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Portfolio</span>
                        </a>

                        {% url 'diversification' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="diversification" data-bs-toggle="tooltip" data-bs-placement="right" title="Diversification">
                            <i class="bi bi-pie-chart-fill me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Diversification</span>
                        </a>

                        {% url 'dividends' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="dividends" data-bs-toggle="tooltip" data-bs-placement="right" title="Dividends">
                            <i class="bi bi-cash-coin me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Dividends</span>
                        </a>

                        {% url 'fees' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="fees" data-bs-toggle="tooltip" data-bs-placement="right" title="Fees">
                            <i class="bi bi-receipt me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Fees</span>
                        </a>

                        {% url 'deposits' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="deposits" data-bs-toggle="tooltip" data-bs-placement="right" title="Deposits">
                            <i class="bi bi-piggy-bank-fill me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Deposits</span>
                        </a>

                        {% url 'trades' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="trades" data-bs-toggle="tooltip" data-bs-placement="right" title="Trades">
                            <i class="bi bi-arrow-left-right me-3 fs-5 sidebar-icon"></i>
                            <span class="sidebar-text">Trades</span>
                        </a>

                        {% url 'account_overview' as url %}
                        <a href="{{ url }}" class="nav-link sidebar-nav-link d-flex align-items-center py-2 mb-1 text-white" data-page="account_overview" data-bs-toggle="tooltip" data-bs-placement="right" title="Account Statement">
                            <i class="bi bi-bank me-3 fs-5 sidebar-icon align-self-start"></i>
                            <span class="sidebar-text">
                                <span class="d-block">Account</span>
                                <span class="d-block">Statement</span>
                            </span>
                        </a>
                    </div>

                    <!-- Connection Status -->
                    <div class="mt-auto px-3 py-3 border-top border-light border-opacity-25 w-100">
                        {% is_connected_to_degiro as is_degiro_connected %}
                        {% get_connected_tooltip as get_connected_tooltip %}
                        <div class="d-flex align-items-center text-white" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-html="true" title="{{ get_connected_tooltip }}">
                            {%  if is_degiro_connected %}
                                <i class="bi-cloud-check-fill me-3 fs-5 text-success sidebar-icon"></i>
                                <span class="small sidebar-text">Connected</span>
                            {% else %}
                                <i class="bi-cloud-slash-fill me-3 fs-5 text-warning sidebar-icon"></i>
                                <span class="small sidebar-text">Disconnected</span>
                            {% endif %}
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col py-3" id="content">
                <!-- Top Navigation Bar -->
                <nav class="navbar navbar-expand-lg navbar-light bg-light" aria-label="Top navigation">
                    <div class="container-fluid justify-content-start">
                        <!-- Shows Total Portfolio -->
                        {% show_total_portfolio %}
                    </div>
                </nav>

                <div class="scrollable-area" style="height: calc(100vh - 100px)">
                    {% block content %}
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="{% static 'bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
    <!-- Bootstrap Table JS -->
    <script src="{% static 'bootstrap-table/dist/bootstrap-table.min.js' %}"></script>
    <script src="{% static 'bootstrap-table/dist/themes/bootstrap-table/bootstrap-table.min.js' %}"></script>

    <script type="text/javascript">
        let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        let tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            const tooltip = new bootstrap.Tooltip(tooltipTriggerEl);
            // Disable navigation tooltips initially (sidebar starts expanded)
            if (tooltipTriggerEl.classList.contains('sidebar-nav-link')) {
                tooltip.disable();
            }
            return tooltip;
        });

        // Fetch configuration data
        fetch("{% url 'configuration' %}", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => response.json())
            .then(data => {
                const selectedPortfolio = document.getElementById("selectPortfolio");
                selectedPortfolio.innerHTML = `<img src="${data.selected_portfolio.logo}" alt="${data.selected_portfolio.id}" width="25" height="25" class="rounded-circle me-2 sidebar-icon flex-shrink-0"><span class="sidebar-text">${data.selected_portfolio.name}</span>`;

                const portfolioMenu = document.getElementById("sidebar-portfolio-menu");
                portfolioMenu.innerHTML = ""; // Clear existing menu items

                if (data.available_portfolios.length === 1) {
                    // Remove the dropdown toggle if there is only one portfolio
                    selectedPortfolio.removeAttribute("data-bs-toggle");
                    selectedPortfolio.classList.remove("dropdown-toggle");
                    selectedPortfolio.classList.add("non-clickable");
                } else {
                    // Show the portfolio selector dropdown only when there are multiple portfolios
                    data.available_portfolios.forEach(portfolio => {
                        const menuItem = document.createElement("li");
                        menuItem.innerHTML = `<a class="dropdown-item portfolio-link-filter" href="#" data-value="${portfolio.id}"><img src="${portfolio.logo}" alt="${portfolio.id}" width="25" height="25" class="rounded-circle me-2">${portfolio.name}</a>`;

                        // Add click event listener to menuItem
                        menuItem.querySelector("a").addEventListener("click", function(event) {
                            event.preventDefault();  // Prevent default link behavior

                            let selectedPortfolio = this.getAttribute("data-value");

                            fetch("{% url 'configuration' %}", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": "{{ csrf_token }}"
                                },
                                body: JSON.stringify({ selected_portfolio: selectedPortfolio })
                            }).then(response => {
                                if (response.ok) {
                                    window.location.reload();
                                }
                            });
                        });

                        portfolioMenu.appendChild(menuItem);
                    });
                }

                // Restore sidebar state after portfolio data is loaded
                restoreSidebarState();
            });

        // Set active navigation state
        function setActiveNavigation() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.sidebar-nav-link');

            navLinks.forEach(link => {
                link.classList.remove('active', 'bg-light', 'bg-opacity-25');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active', 'bg-light', 'bg-opacity-25');
                }
            });
        }

        // Set active navigation on page load
        setActiveNavigation();

        // Restore sidebar state immediately (DOM is already ready since script is at bottom)
        // This ensures sidebar state is restored even if portfolio fetch fails
        restoreSidebarState();

        // Sidebar collapse/expand functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            const toggleIcon = toggleButton.querySelector('i');
            const portfolioButton = document.getElementById('selectPortfolio');

            sidebar.classList.toggle('sidebar-collapsed');

            // Save sidebar state to localStorage
            const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed.toString());

            // Change toggle button icon
            if (isCollapsed) {
                toggleIcon.className = 'bi bi-chevron-right text-primary';

                // Enable tooltips for collapsed state
                enableTooltipsForCollapsedSidebar();

                // Handle portfolio selector tooltip
                if (portfolioButton && portfolioButton.getAttribute('data-tooltip-text')) {
                    portfolioButton.setAttribute('data-bs-toggle-tooltip', 'tooltip');
                    portfolioButton.setAttribute('data-bs-placement', 'right');
                    portfolioButton.setAttribute('title', portfolioButton.getAttribute('data-tooltip-text'));
                    // Initialize tooltip for portfolio button
                    const portfolioTooltip = new bootstrap.Tooltip(portfolioButton);
                    portfolioButton._tooltip = portfolioTooltip; // Store reference for later cleanup
                }
            } else {
                toggleIcon.className = 'bi bi-chevron-left text-primary';

                // Disable tooltips for expanded state
                disableTooltipsForExpandedSidebar();

                // Remove portfolio selector tooltip
                if (portfolioButton) {
                    const tooltipInstance = portfolioButton._tooltip || bootstrap.Tooltip.getInstance(portfolioButton);
                    if (tooltipInstance) {
                        tooltipInstance.dispose();
                        portfolioButton._tooltip = null;
                    }
                    portfolioButton.removeAttribute('data-bs-toggle-tooltip');
                    portfolioButton.removeAttribute('title');
                }
            }
        }

        // Restore sidebar state from localStorage
        function restoreSidebarState() {
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed');
            const sidebar = document.getElementById('sidebar');

            // Clean up the immediate state CSS custom property since JavaScript is now handling it
            if (document.documentElement.style.getPropertyValue('--sidebar-immediate-state')) {
                document.documentElement.style.removeProperty('--sidebar-immediate-state');
            }

            // Apply collapsed state if needed
            if (sidebarCollapsed === 'true') {
                const toggleButton = document.getElementById('sidebarToggle');
                const toggleIcon = toggleButton?.querySelector('i');
                const portfolioButton = document.getElementById('selectPortfolio');

                if (sidebar && !sidebar.classList.contains('sidebar-collapsed')) {
                    sidebar.classList.add('sidebar-collapsed');
                }
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-right text-primary';

                // Enable tooltips for collapsed state
                enableTooltipsForCollapsedSidebar();

                // Handle portfolio selector tooltip
                if (portfolioButton && portfolioButton.getAttribute('data-tooltip-text')) {
                    portfolioButton.setAttribute('data-bs-toggle-tooltip', 'tooltip');
                    portfolioButton.setAttribute('data-bs-placement', 'right');
                    portfolioButton.setAttribute('title', portfolioButton.getAttribute('data-tooltip-text'));
                    // Initialize tooltip for portfolio button
                    const portfolioTooltip = new bootstrap.Tooltip(portfolioButton);
                    portfolioButton._tooltip = portfolioTooltip; // Store reference for later cleanup
                }
            }
        }

        // Enable tooltips when sidebar is collapsed
        function enableTooltipsForCollapsedSidebar() {
            const navLinks = document.querySelectorAll('.sidebar-nav-link[data-bs-toggle="tooltip"]');
            navLinks.forEach(link => {
                const tooltipInstance = bootstrap.Tooltip.getInstance(link);
                if (tooltipInstance) {
                    tooltipInstance.enable();
                }
            });
        }

        // Disable tooltips when sidebar is expanded
        function disableTooltipsForExpandedSidebar() {
            const navLinks = document.querySelectorAll('.sidebar-nav-link[data-bs-toggle="tooltip"]');
            navLinks.forEach(link => {
                const tooltipInstance = bootstrap.Tooltip.getInstance(link);
                if (tooltipInstance) {
                    tooltipInstance.disable();
                }
            });
        }

        // Add event listener to toggle button
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>
