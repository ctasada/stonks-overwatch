name: Build and Release SNAPSHOT

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
#    branches:
#      - master  # Auto-trigger on master push
#
#  workflow_dispatch:  # Allows manual trigger for any branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run common actions
        uses: ./.github/actions/common-action

      - name: Build Package
        run: poetry build

      - name: Determine SNAPSHOT Version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | tr '/' '-')
            echo "SNAPSHOT_VERSION=${BRANCH_NAME}" >> $GITHUB_ENV
          else
            echo "SNAPSHOT_VERSION=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV
          fi

      - name: Delete Previous SNAPSHOT Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TARGET_SNAPSHOT="snapshot-${{ github.ref_name }}"
          else
            TARGET_SNAPSHOT="snapshot-"
          fi

          gh release list --json name -q '.[].name' | grep "^$TARGET_SNAPSHOT" | while read -r release; do
            gh release delete "$release" --yes
          done

      - name: Create New SNAPSHOT Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "snapshot-${SNAPSHOT_VERSION}" dist/* \
            --title "SNAPSHOT ${SNAPSHOT_VERSION}" \
            --notes "Automated SNAPSHOT release from branch '${{ github.ref_name }}'" \
            --prerelease