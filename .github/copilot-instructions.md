# GitHub Copilot Instructions for Stonks Overwatch

> **Note:** For comprehensive guidelines, see [AGENTS.md](../AGENTS.md) - This file is automatically loaded as workspace rules in Cursor.

## Project Overview

Stonks Overwatch is a privacy-first, open-source investment portfolio tracker that consolidates data from multiple brokers (DEGIRO, Bitvavo, IBKR) and runs entirely on the user's local machine.

- **Tech Stack:** Python 3.13+, Django 5.2+, Bootstrap, Charts.js
- **Architecture:** Service-oriented design with Factory pattern, Dependency Injection, and Broker Registry

## Critical Rules - ALWAYS Follow

### Architecture Patterns
- **ALWAYS use `BrokerFactory`** - Never instantiate services directly
- **ALWAYS implement interfaces** - All services must implement their corresponding interface from `core/interfaces/`
- **ALWAYS use dependency injection** - Services receive config via `BaseService`

**✅ CORRECT:**
```python
from stonks_overwatch.core.factories.broker_factory import BrokerFactory
from stonks_overwatch.core.service_types import ServiceType

factory = BrokerFactory()
service = factory.create_service("degiro", ServiceType.PORTFOLIO)
```

**❌ WRONG:**
```python
# NEVER do this - missing config injection
from stonks_overwatch.services.brokers.degiro.services.portfolio_service import DegiroPortfolioService
service = DegiroPortfolioService()  # ❌ WRONG
```

### Code Standards
- **Python 3.13+** required
- **Type hints REQUIRED** for all function signatures (parameters AND return types)
- **Google-style docstrings** for all public functions/classes
- **Line length:** Maximum 120 characters
- **Use `StonksLogger`** - Never use `print()`
- **Edit `staticfiles/`** - Never edit `static/` directory (auto-generated)

### Common Commands
- `make lint-fix` - Auto-fix code style (RUN THIS FIRST)
- `make lint-check` - Verify no linting errors
- `make test` - Run all tests
- `make pre-commit-run` - Run all quality checks
- `make collectstatic` - After editing static files

### File Organization
- New brokers: `services/brokers/<broker_name>/`
- Follow pattern: client → repository → service
- Shared models: `services/models.py`
- Broker-specific models: `brokers/<broker_name>/repositories/models.py`

### Error Handling
- Use structured exceptions from `core/exceptions/`
- Never use bare `except:` - always catch specific exceptions
- Log errors with `StonksLogger` including context (broker name, operation)
- Re-raise exceptions with `from e` to preserve stack trace

### Testing
- Write tests for all new functionality
- Use `unittest.mock` or `pook` for mocking
- Test files: `tests/stonks_overwatch/` mirroring source structure
- Naming: `test_<method_name>_<scenario>`

### Django Conventions
- Use `timezone.now()` not `datetime.now()` for timezone-aware dates
- Use `select_related()` and `prefetch_related()` to avoid N+1 queries
- Keep views thin - delegate business logic to services
- Never edit migration files manually - use `makemigrations`

### Static Files
- **Edit `staticfiles/`** - Source directory for CSS, JS, images
- **Never edit `static/`** - Auto-generated by `collectstatic`
- Run `make collectstatic` after editing `staticfiles/`

## Validation Workflow

After making code changes, ALWAYS run:
1. `make lint-fix` - Auto-fix code style
2. `make lint-check` - Verify no errors
3. `make test` - Ensure all tests pass
4. `make pre-commit-run` - Run all quality checks

## Common Pitfalls to Avoid

- ❌ Don't instantiate services directly - Use `BrokerFactory`
- ❌ Don't edit files in `static/` - Edit `staticfiles/` instead
- ❌ Don't use `print()` - Use `StonksLogger`
- ❌ Don't skip type hints - They're required
- ❌ Don't use bare `except:` - Always catch specific exceptions
- ❌ Don't hardcode paths - Use environment variables or Django settings
- ❌ Don't use HTML in Markdown files - Use pure Markdown syntax only

## Quick Reference

- **Full Guidelines:** [AGENTS.md](../AGENTS.md)
- **Architecture:** [docs/ARCHITECTURE.md](../docs/ARCHITECTURE.md)
- **Broker Integration:** [docs/ARCHITECTURE_BROKERS.md](../docs/ARCHITECTURE_BROKERS.md)
- **Contributing:** [CONTRIBUTING.md](../CONTRIBUTING.md)

---

*This file provides essential guidelines for GitHub Copilot. For comprehensive details, see [AGENTS.md](../AGENTS.md).*
